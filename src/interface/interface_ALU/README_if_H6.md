# if_H6 テストインターフェース 使用ガイド

## 概要
if_H6は、H6_module（乗算器）の各種操作を簡単にテストできるインターフェースモジュールです。
KEY[3:1]で操作モードを選択し、KEY[0]でクロックを進めるだけで動作を確認できます。

## ファイル構成
- `if_H6.v` - H6モジュールのテストインターフェース（トップレベルモジュール）
- `README_if_H6.md` - このガイド
- `H6_module.v` - テスト対象のH6乗算器モジュール（datapath/ALU内）

## Quartusプロジェクトでの使用方法

### トップレベルモジュールとして設定
1. Quartus Primeでプロジェクトを開く
2. `if_H6.v`をプロジェクトに追加
3. `H6_module.v`および関連ファイル（H6.v、transfer_and_16bit.v、or_16bit.vなど）がプロジェクトに含まれていることを確認
4. トップレベルエンティティを`if_H6`に設定
   - Assignments → Settings → General → Top-level entity: `if_H6`
5. ピン配置を設定（下記参照）
6. コンパイルして実行

## ハードウェア接続 (DE2-115ボード)

### 入力ポート（ピン配置時に設定）
| ポート | 機能 | 説明 |
|--------|------|------|
| CLOCK_50 | システムクロック | 50MHz（ボード固定ピン） |
| KEY[0] | クロック/ステップ | 押すたびにクロックが進む |
| KEY[3:1] | テストパターン選択 | 8種類の操作モードを選択 |
| SW[7:0] | A_bus入力値 | 下位8ビットのデータ入力 |
| SW[15:8] | B_bus入力値 | 下位8ビットのデータ入力 |
| SW[16] | 入力ソース選択 | 0=A_bus使用, 1=B_bus使用 |
| SW[17] | 出力イネーブル | 0=出力無効, 1=出力有効 |

**注意**: KEYとSWは負論理です
- 押した/ONの状態 = 0
- 離した/OFFの状態 = 1

### 出力ポート（ピン配置時に設定）
| ポート | 機能 | 説明 |
|--------|------|------|
| LEDR[7:0] | A_mul_bus | Aレジスタ出力値（8ビット） |
| LEDR[15:8] | Q_mul_bus | Qレジスタ出力値（8ビット） |
| LEDG[0] | キャリーフラグ | 演算結果のキャリー |
| LEDG[1] | オーバーフローフラグ | 演算結果のオーバーフロー |
| LEDG[4:2] | 操作モード表示 | 現在選択中のパターン番号 |
| LEDG[5] | 入力制御表示 | 入力がアクティブかどうか |
| LEDG[6] | 操作制御表示 | 演算がアクティブかどうか |
| LEDG[7] | リセット表示 | リセット状態かどうか |

## テストパターン (KEY[3:1]で選択)

**注意**: KEYは負論理のため、押した状態=0、離した状態=1です。

| KEY[3:1] | パターン | 操作 | 説明 | 制御信号 (rst/inTWO/inTHREE/inFOUR) |
|----------|----------|------|------|-------------------------------------|
| 000 | 0 | **リセット** | H6モジュール全体をリセット | 1/-/-/- |
| 001 | 1 | **セットA** | 入力値をAレジスタに設定 | 0/0/0/0 |
| 010 | 2 | **セットQ** | 入力値をQレジスタに設定 | 0/0/0/1 |
| 011 | 3 | **クリアA** | Aレジスタをクリア | 0/0/1/0 |
| 100 | 4 | **クリアQ** | Qレジスタをクリア | 0/0/1/1 |
| 101 | 5 | **加算** | A + Q を実行 | 0/1/0/0 |
| 110 | 6 | **減算** | A - Q を実行 | 0/1/0/1 |
| 111 | 7 | **乗算** | A × Q を実行 | 0/1/1/0 |

## 使用手順

### 基本操作の流れ

1. **ボードに書き込み**: Quartusでコンパイルしたプログラムをボードに書き込む
2. **初期設定**: SW[17]を下げる（出力有効にする）
3. **モード選択**: KEY[3:1]で操作モードを選択
4. **データ入力**: SWで入力データを設定
5. **実行**: KEY[0]を押してクロックを進める
6. **結果確認**: LEDで結果を確認

### 基本的な乗算テスト例: 5 × 3 = 15

1. **初期化（リセット）**
   - KEY[3:1] = 000（すべてのKEYボタンを押す）
   - LEDG[7]が点灯（リセットアクティブ）
   - LEDG[4:2] = 000が点灯
   - KEY[0]を数回押して離す（クロックステップ）

2. **Aレジスタに5を設定**
   - SW[7:0] = 下から5番目まで下げる（値5、2進数で00000101）
   - SW[16] = 上げたまま（A_bus選択）
   - SW[17] = 下げる（出力有効）
   - KEY[3:1] = 001（KEY[3]とKEY[2]を押す、KEY[1]を離す）
   - LEDG[4:2] = 001が点灯
   - KEY[0]を押して離す
   - LEDR[7:0]で5が点灯することを確認

3. **Qレジスタに3を設定**
   - SW[7:0] = 下から3番目まで下げる（値3、2進数で00000011）
   - KEY[3:1] = 010（KEY[3]とKEY[1]を押す、KEY[2]を離す）
   - LEDG[4:2] = 010が点灯
   - KEY[0]を押して離す
   - LEDR[15:8]で3が点灯することを確認

4. **乗算実行**
   - KEY[3:1] = 111（すべてのKEYボタンを離す）
   - LEDG[4:2] = 111（パターン7）が点灯
   - LEDG[6]が点灯（操作アクティブ）
   - KEY[0]を複数回（10回程度）押して離す
   - 結果がLEDR[7:0]とLEDR[15:8]に表示される
   - 5 × 3 = 15なので、適切なレジスタに15(0x0F)が表示される

### 加算テスト例: 10 + 7 = 17

1. **リセット**: KEY[3:1]=000（全押す）, KEY[0]数回押す
2. **Aに10設定**: SW[7:0]で10を設定, SW[17]=下げる, KEY[3:1]=001, KEY[0]押す
3. **Qに7設定**: SW[7:0]で7を設定, KEY[3:1]=010, KEY[0]押す
4. **加算実行**: KEY[3:1]=101（KEY[3]とKEY[1]離す、KEY[2]押す）
   - LEDG[4:2] = 101が点灯
   - KEY[0]数回押す
5. **結果確認**: LEDR表示で17(0x11)を確認

### 減算テスト例: 20 - 8 = 12

1. **リセット**: KEY[3:1]=000（全押す）, KEY[0]数回押す
2. **Aに20設定**: SW[7:0]で20を設定, SW[17]=下げる, KEY[3:1]=001, KEY[0]押す
3. **Qに8設定**: SW[7:0]で8を設定, KEY[3:1]=010, KEY[0]押す
4. **減算実行**: KEY[3:1]=110（KEY[3]離す、KEY[2]とKEY[1]押す）
   - LEDG[4:2] = 110が点灯
   - KEY[0]数回押す
5. **結果確認**: LEDR表示で12(0x0C)を確認

### B_busから入力する例

1. **リセット**: KEY[3:1]=000, KEY[0]押す
2. **B_busに値設定**: SW[15:8]で値を設定（例: 15 = 00001111）
3. **入力ソース切替**: SW[16]=下げる（B_bus選択）
4. **Aに設定**: SW[17]=下げる, KEY[3:1]=001, KEY[0]押す
5. **結果確認**: LEDR[7:0]に15が表示される

## トラブルシューティング

### 正しい値が表示されない
- SW[17]が下がっている（出力有効=1）か確認
- リセット（パターン0）を実行してから再試行
- SW入力値が負論理であることを確認（下げる=1, 上げる=0）

### クロックが進まない
- KEY[0]をしっかり押して離しているか確認
- LEDG[4:2]でパターン番号が表示されているか確認

### 乗算結果が正しくない
- 乗算は複数クロックかかるため、KEY[0]を複数回押す必要がある
- H6モジュールの乗算アルゴリズムに応じた適切なクロック数を確保

### Quartusでコンパイルエラー
- H6_module.vおよび依存ファイルがすべてプロジェクトに追加されているか確認
- 必要なモジュール（transfer_and_16bit、or_16bit、H6など）が含まれているか確認
- トップレベルエンティティが正しくif_H6に設定されているか確認

### ボードに書き込めない
- USBBlasterが正しく接続されているか確認
- デバイスが正しく認識されているか（Programmer画面で確認）
- 正しい.sofファイルを選択しているか確認

## LED表示の読み方

### LEDG (Green LEDs)
```
[7] [6] [5] [4] [3] [2] [1] [0]
 |   |   |    \___  ___/   |   |
 |   |   |        \/       |   |
 |   |   |      Pattern    |   Overflow
 |   |   |      (0-7)      |
 |   |   |                 Carry
 |   |   Input Active
 |   Operation Active
 Reset Active
```

### LEDR (Red LEDs)
```
[15:8]        [7:0]
Q_mul_bus     A_mul_bus
(Qレジスタ)   (Aレジスタ)
```

## Quartusでのピン配置設定例

if_H6をトップレベルとして設定する場合、以下のようにピン配置を行います：

```tcl
# Clock
set_location_assignment PIN_Y2 -to CLOCK_50

# Keys (負論理)
set_location_assignment PIN_R24 -to KEY[0]
set_location_assignment PIN_N21 -to KEY[1]
set_location_assignment PIN_M21 -to KEY[2]
set_location_assignment PIN_M23 -to KEY[3]

# Switches (負論理) - 例
set_location_assignment PIN_AB28 -to SW[0]
set_location_assignment PIN_AC28 -to SW[1]
# ... (SW[2]～SW[17]も同様に設定)

# Red LEDs
set_location_assignment PIN_G19 -to LEDR[0]
set_location_assignment PIN_F19 -to LEDR[1]
# ... (LEDR[2]～LEDR[15]も同様に設定)

# Green LEDs
set_location_assignment PIN_E21 -to LEDG[0]
set_location_assignment PIN_E22 -to LEDG[1]
# ... (LEDG[2]～LEDG[7]も同様に設定)
```

※ 実際のピン番号はDE2-115のマニュアルまたは既存プロジェクトのピン配置を参照してください

## 注意事項

1. **負論理**: DE2-115ボードのKEYとSWは負論理です
   - 押した/ONの状態 = 0
   - 離した/OFFの状態 = 1

2. **8ビット表示**: 本インターフェースは下位8ビットのみ表示します
   - 16ビット全体をテストする場合は上位8ビット対応の追加が必要

3. **クロック制御**: KEY[0]でマニュアルクロック制御
   - 1回押すごとに1クロックステップ進む
   - 乗算など複数クロックが必要な操作では複数回押す

4. **H6の内部動作**: H6モジュールの詳細な動作は内部実装に依存します
   - 適切な制御シーケンスが必要な場合があります

## さらなる改良案

- 自動クロック生成モード（SW設定で連続実行）
- 16ビット全体の表示対応（HEX表示の追加）
- 7セグメントディスプレイへの10進数表示
- シーケンシャルテストパターンの自動実行
- より詳細なデバッグ情報の表示（内部状態の可視化）

## 参考

- [H6_module.v](../../datapath/ALU/H6_module.v) - テスト対象のH6モジュール本体
- [if_H4.v](if_H4.v) - H4（ALU）のテストインターフェース参考実装
- DE2-115 User Manual - ハードウェア仕様とピン配置
