# SEP-3 テストプログラム仕様書

## 概要

情報科学実験Cで学生が設計したCPUをテストするためのサンプルプログラムがROMに格納されている。SEP-3の命令セット（学生が独自に追加した命令は除く）の動作確認のために使用する。

サンプルプログラムは5つ用意されており、命令の動作を確認することができる。なお、テストの前提として`mov`命令や入出力の回路は「正しく動作する」ことを仮定している。

演算結果の正確さを確認するだけでなく、演算の結果、設定されるPSWのフラグが正しくセットされているかどうかを含めてチェックすること。SUB系のCフラグのセット／リセットについて特に重点的に点検すること。

## サンプルプログラム一覧

| サンプルプログラム名 | 開始番地 | 主にテストする命令 |
|---------------------|---------|-------------------|
| サンプルプログラム1 | 0xf840  | ASL, ASR, LSL, LSR, ROL, ROR, CLR |
| サンプルプログラム2 | 0xf848  | OR, XOR, AND |
| サンプルプログラム3 | 0xf850  | ADD, SUB, BRx |
| サンプルプログラム4 | 0xf858  | JMP, RJP, RBx |
| サンプルプログラム5 | 0xf860  | JSR, RJS, RET |

## 実行方法

各サンプルプログラムは、0xf800番地の「実行開始番地入力ルーチン」で各サンプルプログラムの開始番地を入力し、開始番地へジャンプすることで実行することができる。

「実行開始番地入力ルーチン」の実行方法はサービスルーチンのページを参照のこと。

## サンプルプログラム1 (0xf840〜)

### テスト内容
CLR命令及びシフト命令(ASL, ASR, LSL, LSR, ROL, ROR)のテストを行う。16bit赤色LED（以下、データ出力LED）を使用して、データがシフトされていく様子を観察できるプログラムである。

### 実行順序

#### 第1チェック　CLR命令
1. データ出力LEDに0xFFFFが表示される（0xffffが表示されない場合、JMP命令のミスかも）
2. ACK待ち
3. データ出力LEDがすべて消える(0x0000が表示される)

データ出力ランプがすべて消えれば、CLR命令は正しく動作されている。

#### 第2チェック　ASL命令
1. データ出力LEDに0x7A80が表示される
2. ACK待ち
3. 算術左シフトを実行、結果をデータ出力LEDに表示する
4. キャリーが発生していれば、2．へ戻る

7A80→7500→6A00→5400→2800と変化することが確認できれば、ASL命令は正しく動作していると考えられる。

#### 第3チェック　ASR命令
1. データ出力LEDに0x80A8が表示される
2. ACK待ち
3. 算術右シフトを実行、結果をデータ出力LEDに表示する
4. キャリーが発生していなければ、2．へ戻る

80A8→C054→E02A→F015と変化することが確認できれば、ASR命令は正しく動作していると考えられる。

#### 第4チェック　LSL命令
1. データ出力LEDに0xF500が表示される
2. ACK待ち
3. 論理左シフトを実行、結果をデータ出力LEDに表示する
4. キャリーが発生していれば、2．へ戻る

F500→EA00→D400→A800→5000と変化することが確認できれば、LSL命令は正しく動作していると考えられる。

#### 第5チェック　LSR命令
1. データ出力LEDに0x0A0Fが表示される
2. ACK待ち
3. 論理右シフトを実行、結果をデータ出力LEDに表示する
4. キャリーが発生していれば、2．へ戻る

0A0F→0507→0283→0141→00A0と変化することが確認できれば、LSR命令は正しく動作していると考えられる。

#### 第6チェック　ROL命令
1. データ出力LEDに0xF0A0が表示される
2. ACK待ち
3. ローテート左シフトを実行、結果をデータ出力LEDに表示する
4. キャリーが発生していれば、2．へ戻る

F0A0→E141→C283→8507→0A0Fと変化することが確認できれば、ROL命令は正しく動作していると考えられる。

#### 第7チェック　ROR命令
1. データ出力LEDに0x0A0Fが表示される
2. ACK待ち
3. ローテート右シフトを実行、結果をデータ出力LEDに表示する
4. キャリーが発生していれば、2．へ戻る

0A0F→8507→C283→E141→F0A0と変化することが確認できれば、ROR命令は正しく動作していると考えられる。

サンプルプログラム1は最後にHALT命令によって停止する。

## サンプルプログラム2 (0xf848〜)

### テスト内容
論理演算命令(OR, XOR, AND)のテストを行う。データ出力LEDを使用して、各論理演算の１ビット毎の演算結果を確認する。

### 実行内容

データ出力LEDの下位4ビットの変化は以下の通りである。

| 演算の意味 | 実行順 | 入力LEDR[3] | 入力LEDR[2] | 入力LEDR[1] | 入力LEDR[0] | 結果LEDR[3..0] |
|-----------|--------|------------|------------|------------|------------|----------------|
| OR        | (1)    | 1 or 1     | 1 or 0     | 0 or 1     | 0 or 0     | 1110           |
| XOR       | (2)    | 1 xor 1    | 1 xor 0    | 0 xor 1    | 0 xor 0    | 0110           |
| AND       | (3)    | 1 and 1    | 1 and 0    | 0 and 1    | 0 and 0    | 1000           |

データ出力LEDの下位4ビットが1110→0110→1000と変化することが確認できれば、論理演算命令は正しく動作していると考えられる。

## サンプルプログラム3 (0xf850〜)

### テスト内容
算術演算命令(ADD，SUB)及びPSW(N,Z,V,C)のセットと分岐命令(BRx)のテストを行う。テスト対象の分岐命令をすべて正しく実行するとデータ出力LEDに0x0001が表示されて、HALT命令により停止する。

### 実行順序

#### 第1チェック　ADD命令
1. 0xEFFF+1 を実行する
2. データ出力LEDに0xF000が表示される
3. ACK待ち

データ出力ランプにF000が表示されれば、ADD命令は正しく動作していると思われる。

#### 第2チェック　SUB命令
1. 0xF000−0xF000 を実行する
2. データ出力LEDがすべて消える(0x0000が表示される)
3. ACK待ち

データ出力ランプがすべて消灯していれば、SUB命令は正しく動作していると思われる。

#### 第3チェック　BRx命令
1. PSWの各フラグを立てる
2. フラグにしたがって条件判定ジャンプを行う
3. 終了コード0x0001をデータ出力LEDに出力して停止する

データ出力LEDに0x0001が表示されれば、PSWの各フラグのセットとBRx命令は正しく動作しているものと思われる。

## サンプルプログラム4 (0xf858〜)

### テスト内容
PSW(N,Z,V,C)のセットと分岐命令(JMP, RJP, RBx)のテストを行う。テスト対象の分岐命令をすべて正しく実行するとデータ出力LEDに0x0001を表示して停止する。

他のサンプルプログラムでは、PSWの評価とそれに伴う分岐を使用しているため、このプログラムによるチェックを最初にテストするとよい。

### 実行順序

1. プログラム開始
2. 条件分岐命令の場合には、対応するPSWのフラグをたてる
3. 分岐命令を実行する
4. すべて正しく分岐すればデータ出力LEDに0x0001を出力して停止する。フラグの判定が正しく行われていないと、データ出力LEDに0xFFFFを出力して停止する(はず)

データ出力LEDに0x0001が表示されれば、PSWの各フラグのセットと分岐命令(JMP,RJP,RBx)は正しく動作しているものと思われる。

## サンプルプログラム5 (0xf860〜)

### テスト内容
サブルーチンコール命令(JSR, RJS, RET)のテストを行う。データ出力LEDに0x0001→0x0002の表示されて停止すれば、正しくサブルーチンへジャンプして戻って来ていることを確認できる。

正しく分岐しない、正しく復帰しないときには、どこへ分岐するか予測不能なためPCの値などを参考にして下位の修正を行う。

### 実行順序

#### 第1チェック　JSR命令
1. JSR命令を実行
2. データ出力LEDに0x0001を表示
3. ACK待ち
4. RET命令を実行

データ出力LEDに0x0001が表示されていれば、JSR命令は正しく動作している。

#### 第2チェック　RJS命令
1. RJS命令を実行
2. データ出力LEDに0x0002が表示される
3. ACK待ち
4. RET命令を実行
5. HLT命令で停止

データ出力LEDに0x0002が表示されていれば、サブルーチンコール命令(JSR,RJS,RET)は正しく動作している。

## 注意事項

- テストの前提として`mov`命令や入出力の回路は「正しく動作する」ことを仮定している
- 演算結果の正確さを確認するだけでなく、演算の結果、設定されるPSWのフラグが正しくセットされているかどうかを含めてチェックすること
- SUB系のCフラグのセット／リセットについて特に重点的に点検すること
- サンプルプログラム4によるチェックを最初にテストするとよい

